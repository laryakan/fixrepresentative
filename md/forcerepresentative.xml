<?xml version="1.0" encoding="utf-8"?>
<mdscript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd" name="ForceRepresentative">
	<cues>
		<!-- First version, force spawn of FRF Representative -->
		<cue name="ForceRepresentative_Start">
			<conditions>
				<!-- CHECK 1 TIME AT START -->
				<event_cue_signalled cue="md.Setup.Start" />
			</conditions>
			<delay exact="10s" />
			<actions>
				<show_notification text="'Dispatching the Missing Representative Task Force, aka MRTF...'"/>
				<!-- FREE FAMILIES CHECK -->
				<set_value name="ForceRepresentative.$Faction" exact="faction.freesplit"/>
				<signal_cue cue="ForceRepresentative" />
			</actions>
		</cue>
		
		<!-- First version, force spawn of FRF Representative -->
		<cue name="ForceRepresentative" namespace="this" >
			<conditions>
				<event_cue_signalled />
				<!-- this.$Faction must be defined in this namespace (ForceRepresentative) before signal_cue -->
				<check_value value="this.$Faction"/>
			</conditions>
			<actions>
				<debug_text text="'ForceRepresentative - Received an instruction to check representative for : ' + this.$Faction" />
				
				<set_value name="this.$SearchSpace" exact="player.galaxy"/>
				
				<debug_text text="'ForceRepresentative - ' + this.$Faction.name + ' check'" />

				<do_if value="not this.$Faction.representative.exists and this.$Faction.isactive">
					<!-- Rep Missing -->
					<show_notification text="'MRTF SITREP: ' + this.$Faction.name + ' representative missing'"/>
					<debug_text text="'ForceRepresentative - ' + this.$Faction.name + ' representative missing, trying to relocate HQ'" />
					<!-- Trying to find new HQ with the game methods -->
					<remove_value name="md.$FactionData.{this.$Faction}.$Headquarters"/>
					<remove_value name="md.$FactionData.{this.$Faction}.$Representative" comment="can't set it to null, just remove it"/>
					
					<!-- Recheck, if the game has detected the missing Representative -->
					<do_if value="not this.$Faction.representative.exists">
						<debug_text text="'ForceRepresentative - ' + this.$Faction.name + ' forced HQ reset didnt solved the problem'" />
						<!-- if representative still do not exists, we change the HQ no matter what -->
						<!-- <find_station_by_true_owner name="this.$HQ" space="this.$SearchSpace" faction="this.$Faction" /> -->
						<find_station name="this.$HQ" space="this.$SearchSpace" owner="this.$Faction"/>
						
						<do_if value="this.$HQ and this.$HQ.isoperational">
							<!-- setting up the new HQ, extending data scope -->
							<set_value name="md.$FactionData.{$Faction}.$Headquarters" exact="this.$HQ" />
							<!-- and then we create the representative -->
							<create_representative_actor name="this.$Representative" station="this.$HQ" faction="this.$Faction" />
							<!-- create room and place npc -->
							<signal_cue_instantly cue="ForceRepresentativeRoom" />
							<!-- extending data scope -->
							<set_value name="md.$FactionData.{this.$Faction}.$Representative" exact="this.$Representative" />
						</do_if>
						<do_else>
							<!-- we didnt find any eligible station -->
							<debug_text text="'ForceRepresentative - ' + this.$Faction.name + ' representative cant find HQ'"  filter="error" />
						</do_else>
					</do_if>
					<!-- Last check if representative exists and have a roomm where we can find hem -->
					<do_if value="not this.$Faction.representative.exists" >
						<show_notification text="'MRTF SITREP: ' + this.$Faction.name + ' representative unreachable'" />
						<debug_text text="'ForceRepresentative - Cant spawn ' + this.$Faction.name + '  Representative'"  filter="error" />
					</do_if>
					<do_else>
						<!-- we made the representative respawned -->
						<show_notification text="'MRTF SITREP: ' + this.$Faction.name + ' representative recovered'"/>
						<debug_text text="'ForceRepresentative - ' + this.$Faction.name + ' representative spawned'" />
					</do_else>
				</do_if>
				<do_else>
					<!-- if representative already exists, we do nothing -->
					<debug_text text="'ForceRepresentative - ' + this.$Faction.name + ' representative already exists or faction is not active'" />
				</do_else>
			</actions>
		</cue>
		
		<cue name="ForceRepresentativeRoom" namespace="this" >
			<conditions>
				<event_cue_signalled />
				<check_value value="ForceRepresentative.$Faction"/>
				<check_value value="ForceRepresentative.$HQ"/>
				<check_value value="ForceRepresentative.$Representative"/>
			</conditions>
			<actions>
				<debug_text text="'ForceRepresentative - Create room for ' + ForceRepresentative.$Faction.name + '  Representative'" />
				<!-- In most case, if the representative wasnt in the universe, he doesnt have any room to sit, this script (almost Vanilla) will make a romm on designated station -->
				<!-- I take values in ForceRepresentative namespace --> 
				<set_value name="this.$Faction" exact="ForceRepresentative.$Faction"/>
				<set_value name="this.$HQ" exact="ForceRepresentative.$HQ"/>
				<set_value name="this.$Race" exact="this.$HQ.owner.primaryrace" />
				<set_value name="this.$InteriorSeed" exact="this.$HQ.seed + lookup.roomtype.list.indexof.{roomtype.factionrep}"/>
				<set_value name="this.$Representative" exact="ForceRepresentative.$Representative"/>

				<!-- Logical --> 
				<get_room_definition macro="this.$CorridorMacro" race="this.$Race" tags="tag.administrationcorridor" seed="this.$InteriorSeed" />
				<do_if value="not this.$CorridorMacro">
					<get_room_definition macro="this.$CorridorMacro" race="this.$Race" tags="tag.corridor" seed="this.$InteriorSeed" />
				</do_if>
				<get_room_definition macro="this.$RoomMacro" doors="this.$RoomDoors" race="this.$Race" tags="tag.factionrep" seed="this.$InteriorSeed" />
				<!-- Create room -->
				<substitute_text text="this.$InteriorName" source="readtext.{30003}.{10004}">
					<replace string="'$FACTION$'" with="$Faction.name" />
				</substitute_text>
				<create_dynamic_interior object="this.$HQ" corridor="this.$CorridorMacro" room="this.$RoomMacro" name="this.$InteriorName" interiorname="this.$Interior" corridorname="this.$Corridor" roomname="this.$Room" roomtype="roomtype.factionrep" seed="this.$InteriorSeed" />
				<do_if value="this.$Interior and this.$Corridor and this.$Room">
					<!-- Create room -->
					<debug_text text="'ForceRepresentative -  Interior for ' + this.$Representative.name + ' created'" />
					<find_npc_slot name="this.$NPCSlot" object="this.$Room" tags="tag.control"/>
					<do_if value="not this.$NPCSlot">
						<find_npc_slot name="this.$NPCSlot" object="this.$Room" />
					</do_if>
					<do_if value="this.$NPCSlot">
						<!-- Place faction representative -->
						<add_actor_to_room actor="this.$Representative" slot="this.$NPCSlot" />
						<debug_text text="'ForceRepresentative - Representative ' + this.$Representative.name + ' added to room ' + this.$Room + ' (' + this.$RoomMacro + ')'" />
					</do_if>
					<do_else>
						<debug_text text="'ForceRepresentative - Could not find slot for ' + this.$Representative.name + ' ({' + $FactionRepresentative + '}) in ' + this.$Room + '(' + this.$RoomMacro + ')'" filter="error" />
					</do_else>
				</do_if>
				<do_else>
					<debug_text text="'ForceRepresentative - Interior for ' + this.$Representative.name + ' could not be created using this.$CorridorMacro: ' + this.$CorridorMacro + ' and this.$RoomMacro: ' + this.$RoomMacro" filter="error" />
				</do_else>
			</actions>
		</cue>
	</cues>
</mdscript>